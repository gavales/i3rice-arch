"use babel";

Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.activate = activate;
exports.deactivate = deactivate;
exports.handleURI = handleURI;
exports.deserialize = deserialize;
var path = null;
var PdfEditorView = null;
var querystring = null;
var subscriptions = null;

var _require = require('atom');

var CompositeDisposable = _require.CompositeDisposable;

function activate(state) {
  subscriptions = new CompositeDisposable(atom.workspace.addOpener(openUri), atom.packages.onDidActivateInitialPackages(createPdfStatusView), atom.config.observe('pdf-view.fileExtensions', updateFileExtensions), atom.commands.add('atom-workspace', 'pdf-view:toggle-binary-view', toggleBinaryView));
}

function deactivate() {
  if (subscriptions) {
    subscriptions.dispose();
  }
}

function handleURI(parsedUri) {
  var query = Object.assign({}, parsedUri.query);

  if (parsedUri.hash) {
    // Allow query parameters to exist in hash to main compatability with Adobe
    // PDF style urls.
    if (parsedUri.hash.includes('=')) {
      if (querystring === null) {
        querystring = require('querystring');
      }

      Object.assign(query, querystring.parse(parsedUri.hash.substring(1)));
    } else {
      query.nameddest = parsedUri.hash.substring(1);
    }
  }

  var filePath = query.path || pathnameToFilePath(parsedUri.pathname);

  atom.workspace.open(filePath).then(function (view) {
    if (view) {
      if (query.source && query.line) {
        view.forwardSync(query.source, query.line);
      } else if (query.page) {
        view.scrollToPage(query.page);
      } else if (query.nameddest) {
        view.scrollToNamedDest(query.nameddest);
      }
    }
  });
}

function pathnameToFilePath(pathname) {
  var filePath = decodeURI(pathname || '');

  if (process.platform === 'win32') {
    filePath = filePath.replace(/\//g, '\\').replace(/^(.+)\|/, '$1:').replace(/\\([A-Z]:\\)/, '$1');
  } else if (!filePath.startsWith('/')) {
    filePath = '/' + filePath;
  }

  return filePath;
}

// Files with these extensions will be opened as PDFs
var pdfExtensions = new Set();

function updateFileExtensions(extensions) {
  pdfExtensions.clear();
  for (var extension of extensions) {
    extension = extension.toLowerCase().replace(/^\.*/, '.');
    pdfExtensions.add(extension);
  }
}

function openUri(uriToOpen) {
  if (path === null) {
    path = require('path');
  }

  var uriExtension = path.extname(uriToOpen).toLowerCase();
  if (pdfExtensions.has(uriExtension)) {
    if (PdfEditorView === null) {
      PdfEditorView = require('./pdf-editor-view');
    }
    return new PdfEditorView(uriToOpen);
  }
}

function toggleBinaryView() {
  if (PdfEditorView === null) {
    PdfEditorView = require('./pdf-editor-view');
  }
  var paneItem = atom.workspace.getActivePaneItem();
  if (!paneItem || !(paneItem instanceof PdfEditorView)) {
    return;
  }
  paneItem.binaryView = !paneItem.binaryView;
}

function createPdfStatusView() {
  var PdfStatusBarView = require('./pdf-status-bar-view');
  new PdfStatusBarView();
  var PdfGoToPageView = require('./pdf-goto-page-view');
  new PdfGoToPageView();
}

function deserialize(_ref) {
  var filePath = _ref.filePath;
  var scale = _ref.scale;
  var scrollTop = _ref.scrollTop;
  var scrollLeft = _ref.scrollLeft;

  if (require('fs-plus').isFileSync(filePath)) {
    if (PdfEditorView === null) {
      PdfEditorView = require('./pdf-editor-view');
    }
    return new PdfEditorView(filePath, scale, scrollTop, scrollLeft);
  } else {
    console.warn("Could not deserialize PDF editor for path '#{filePath}' because that file no longer exists");
  }
}

if (parseFloat(atom.getVersion()) < 1.7) {
  atom.deserializers.add({
    "name": "PdfEditorDeserializer",
    "deserialize": deserialize
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2dhdmFyY2gvLmF0b20vcGFja2FnZXMvcGRmLXZpZXcvbGliL3BkZi1lZGl0b3IuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFDOzs7Ozs7Ozs7QUFFWixJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7QUFDaEIsSUFBSSxhQUFhLEdBQUcsSUFBSSxDQUFDO0FBQ3pCLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQztBQUN2QixJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUM7O2VBQ0ssT0FBTyxDQUFDLE1BQU0sQ0FBQzs7SUFBdEMsbUJBQW1CLFlBQW5CLG1CQUFtQjs7QUFFbkIsU0FBUyxRQUFRLENBQUMsS0FBSyxFQUFFO0FBQzlCLGVBQWEsR0FBRyxJQUFJLG1CQUFtQixDQUNyQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFDakMsSUFBSSxDQUFDLFFBQVEsQ0FBQyw0QkFBNEIsQ0FBQyxtQkFBbUIsQ0FBQyxFQUMvRCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyx5QkFBeUIsRUFBRSxvQkFBb0IsQ0FBQyxFQUNwRSxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSw2QkFBNkIsRUFBRSxnQkFBZ0IsQ0FBQyxDQUNyRixDQUFDO0NBQ0g7O0FBRU0sU0FBUyxVQUFVLEdBQUc7QUFDM0IsTUFBSSxhQUFhLEVBQUU7QUFDakIsaUJBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztHQUN6QjtDQUNGOztBQUVNLFNBQVMsU0FBUyxDQUFDLFNBQVMsRUFBRTtBQUNuQyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUE7O0FBRWhELE1BQUksU0FBUyxDQUFDLElBQUksRUFBRTs7O0FBR2xCLFFBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDaEMsVUFBSSxXQUFXLEtBQUssSUFBSSxFQUFFO0FBQ3hCLG1CQUFXLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFBO09BQ3JDOztBQUVELFlBQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQ3JFLE1BQU07QUFDTCxXQUFLLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQzlDO0dBQ0Y7O0FBRUQsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksSUFBSSxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUE7O0FBRXJFLE1BQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUksRUFBSTtBQUN6QyxRQUFJLElBQUksRUFBRTtBQUNSLFVBQUksS0FBSyxDQUFDLE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFO0FBQzlCLFlBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7T0FDM0MsTUFBTSxJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUU7QUFDckIsWUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7T0FDOUIsTUFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUU7QUFDMUIsWUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQTtPQUN4QztLQUNGO0dBQ0YsQ0FBQyxDQUFBO0NBQ0g7O0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUU7QUFDcEMsTUFBSSxRQUFRLEdBQUcsU0FBUyxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUMsQ0FBQTs7QUFFeEMsTUFBSSxPQUFPLENBQUMsUUFBUSxLQUFLLE9BQU8sRUFBRTtBQUNoQyxZQUFRLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFBO0dBQ2pHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDcEMsWUFBUSxTQUFPLFFBQVEsQUFBRSxDQUFBO0dBQzFCOztBQUVELFNBQU8sUUFBUSxDQUFBO0NBQ2hCOzs7QUFHRCxJQUFNLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDOztBQUVoQyxTQUFTLG9CQUFvQixDQUFDLFVBQVUsRUFBRTtBQUN4QyxlQUFhLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDdEIsT0FBSyxJQUFJLFNBQVMsSUFBSSxVQUFVLEVBQUU7QUFDaEMsYUFBUyxHQUFHLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ3pELGlCQUFhLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0dBQzlCO0NBQ0Y7O0FBRUQsU0FBUyxPQUFPLENBQUMsU0FBUyxFQUFFO0FBQzFCLE1BQUksSUFBSSxLQUFLLElBQUksRUFBRTtBQUNqQixRQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0dBQ3hCOztBQUVELE1BQUksWUFBWSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUE7QUFDeEQsTUFBSSxhQUFhLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFO0FBQ25DLFFBQUksYUFBYSxLQUFLLElBQUksRUFBRTtBQUMxQixtQkFBYSxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0tBQzlDO0FBQ0QsV0FBTyxJQUFJLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztHQUNyQztDQUNGOztBQUVELFNBQVMsZ0JBQWdCLEdBQUc7QUFDMUIsTUFBRyxhQUFhLEtBQUssSUFBSSxFQUFFO0FBQ3pCLGlCQUFhLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7R0FDOUM7QUFDRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGlCQUFpQixFQUFFLENBQUM7QUFDcEQsTUFBRyxDQUFDLFFBQVEsSUFBSSxFQUFFLFFBQVEsWUFBWSxhQUFhLENBQUEsQUFBQyxFQUFFO0FBQ3BELFdBQU87R0FDUjtBQUNELFVBQVEsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDO0NBQzVDOztBQUVELFNBQVMsbUJBQW1CLEdBQUc7QUFDN0IsTUFBSSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUN4RCxNQUFJLGdCQUFnQixFQUFFLENBQUM7QUFDdkIsTUFBSSxlQUFlLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDdEQsTUFBSSxlQUFlLEVBQUUsQ0FBQztDQUN2Qjs7QUFFTSxTQUFTLFdBQVcsQ0FBQyxJQUF3QyxFQUFFO01BQXpDLFFBQVEsR0FBVCxJQUF3QyxDQUF2QyxRQUFRO01BQUUsS0FBSyxHQUFoQixJQUF3QyxDQUE3QixLQUFLO01BQUUsU0FBUyxHQUEzQixJQUF3QyxDQUF0QixTQUFTO01BQUUsVUFBVSxHQUF2QyxJQUF3QyxDQUFYLFVBQVU7O0FBQ2pFLE1BQUksT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRTtBQUMzQyxRQUFJLGFBQWEsS0FBSyxJQUFJLEVBQUU7QUFDMUIsbUJBQWEsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztLQUM5QztBQUNELFdBQU8sSUFBSSxhQUFhLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUM7R0FDbEUsTUFBTTtBQUNMLFdBQU8sQ0FBQyxJQUFJLENBQUMsNEZBQTRGLENBQUMsQ0FBQztHQUM1RztDQUNGOztBQUVELElBQUksVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRTtBQUN2QyxNQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQztBQUNyQixVQUFNLEVBQUUsdUJBQXVCO0FBQy9CLGlCQUFhLEVBQUUsV0FBVztHQUMzQixDQUFDLENBQUM7Q0FDSiIsImZpbGUiOiIvaG9tZS9nYXZhcmNoLy5hdG9tL3BhY2thZ2VzL3BkZi12aWV3L2xpYi9wZGYtZWRpdG9yLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2UgYmFiZWxcIjtcblxubGV0IHBhdGggPSBudWxsO1xubGV0IFBkZkVkaXRvclZpZXcgPSBudWxsO1xubGV0IHF1ZXJ5c3RyaW5nID0gbnVsbDtcbmxldCBzdWJzY3JpcHRpb25zID0gbnVsbDtcbmNvbnN0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSA9IHJlcXVpcmUoJ2F0b20nKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGFjdGl2YXRlKHN0YXRlKSB7XG4gIHN1YnNjcmlwdGlvbnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZShcbiAgICBhdG9tLndvcmtzcGFjZS5hZGRPcGVuZXIob3BlblVyaSksXG4gICAgYXRvbS5wYWNrYWdlcy5vbkRpZEFjdGl2YXRlSW5pdGlhbFBhY2thZ2VzKGNyZWF0ZVBkZlN0YXR1c1ZpZXcpLFxuICAgIGF0b20uY29uZmlnLm9ic2VydmUoJ3BkZi12aWV3LmZpbGVFeHRlbnNpb25zJywgdXBkYXRlRmlsZUV4dGVuc2lvbnMpLFxuICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsICdwZGYtdmlldzp0b2dnbGUtYmluYXJ5LXZpZXcnLCB0b2dnbGVCaW5hcnlWaWV3KVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVhY3RpdmF0ZSgpIHtcbiAgaWYgKHN1YnNjcmlwdGlvbnMpIHtcbiAgICBzdWJzY3JpcHRpb25zLmRpc3Bvc2UoKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFuZGxlVVJJKHBhcnNlZFVyaSkge1xuICBjb25zdCBxdWVyeSA9IE9iamVjdC5hc3NpZ24oe30sIHBhcnNlZFVyaS5xdWVyeSlcblxuICBpZiAocGFyc2VkVXJpLmhhc2gpIHtcbiAgICAvLyBBbGxvdyBxdWVyeSBwYXJhbWV0ZXJzIHRvIGV4aXN0IGluIGhhc2ggdG8gbWFpbiBjb21wYXRhYmlsaXR5IHdpdGggQWRvYmVcbiAgICAvLyBQREYgc3R5bGUgdXJscy5cbiAgICBpZiAocGFyc2VkVXJpLmhhc2guaW5jbHVkZXMoJz0nKSkge1xuICAgICAgaWYgKHF1ZXJ5c3RyaW5nID09PSBudWxsKSB7XG4gICAgICAgIHF1ZXJ5c3RyaW5nID0gcmVxdWlyZSgncXVlcnlzdHJpbmcnKVxuICAgICAgfVxuXG4gICAgICBPYmplY3QuYXNzaWduKHF1ZXJ5LCBxdWVyeXN0cmluZy5wYXJzZShwYXJzZWRVcmkuaGFzaC5zdWJzdHJpbmcoMSkpKVxuICAgIH0gZWxzZSB7XG4gICAgICBxdWVyeS5uYW1lZGRlc3QgPSBwYXJzZWRVcmkuaGFzaC5zdWJzdHJpbmcoMSlcbiAgICB9XG4gIH1cblxuICBjb25zdCBmaWxlUGF0aCA9IHF1ZXJ5LnBhdGggfHwgcGF0aG5hbWVUb0ZpbGVQYXRoKHBhcnNlZFVyaS5wYXRobmFtZSlcblxuICBhdG9tLndvcmtzcGFjZS5vcGVuKGZpbGVQYXRoKS50aGVuKHZpZXcgPT4ge1xuICAgIGlmICh2aWV3KSB7XG4gICAgICBpZiAocXVlcnkuc291cmNlICYmIHF1ZXJ5LmxpbmUpIHtcbiAgICAgICAgdmlldy5mb3J3YXJkU3luYyhxdWVyeS5zb3VyY2UsIHF1ZXJ5LmxpbmUpXG4gICAgICB9IGVsc2UgaWYgKHF1ZXJ5LnBhZ2UpIHtcbiAgICAgICAgdmlldy5zY3JvbGxUb1BhZ2UocXVlcnkucGFnZSlcbiAgICAgIH0gZWxzZSBpZiAocXVlcnkubmFtZWRkZXN0KSB7XG4gICAgICAgIHZpZXcuc2Nyb2xsVG9OYW1lZERlc3QocXVlcnkubmFtZWRkZXN0KVxuICAgICAgfVxuICAgIH1cbiAgfSlcbn1cblxuZnVuY3Rpb24gcGF0aG5hbWVUb0ZpbGVQYXRoKHBhdGhuYW1lKSB7XG4gIGxldCBmaWxlUGF0aCA9IGRlY29kZVVSSShwYXRobmFtZSB8fCAnJylcblxuICBpZiAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJykge1xuICAgIGZpbGVQYXRoID0gZmlsZVBhdGgucmVwbGFjZSgvXFwvL2csICdcXFxcJykucmVwbGFjZSgvXiguKylcXHwvLCAnJDE6JykucmVwbGFjZSgvXFxcXChbQS1aXTpcXFxcKS8sICckMScpXG4gIH0gZWxzZSBpZiAoIWZpbGVQYXRoLnN0YXJ0c1dpdGgoJy8nKSkge1xuICAgIGZpbGVQYXRoID0gYC8ke2ZpbGVQYXRofWBcbiAgfVxuXG4gIHJldHVybiBmaWxlUGF0aFxufVxuXG4vLyBGaWxlcyB3aXRoIHRoZXNlIGV4dGVuc2lvbnMgd2lsbCBiZSBvcGVuZWQgYXMgUERGc1xuY29uc3QgcGRmRXh0ZW5zaW9ucyA9IG5ldyBTZXQoKTtcblxuZnVuY3Rpb24gdXBkYXRlRmlsZUV4dGVuc2lvbnMoZXh0ZW5zaW9ucykge1xuICBwZGZFeHRlbnNpb25zLmNsZWFyKCk7XG4gIGZvciAobGV0IGV4dGVuc2lvbiBvZiBleHRlbnNpb25zKSB7XG4gICAgZXh0ZW5zaW9uID0gZXh0ZW5zaW9uLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXlxcLiovLCAnLicpO1xuICAgIHBkZkV4dGVuc2lvbnMuYWRkKGV4dGVuc2lvbik7XG4gIH1cbn1cblxuZnVuY3Rpb24gb3BlblVyaSh1cmlUb09wZW4pIHtcbiAgaWYgKHBhdGggPT09IG51bGwpIHtcbiAgICBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuICB9XG5cbiAgbGV0IHVyaUV4dGVuc2lvbiA9IHBhdGguZXh0bmFtZSh1cmlUb09wZW4pLnRvTG93ZXJDYXNlKClcbiAgaWYgKHBkZkV4dGVuc2lvbnMuaGFzKHVyaUV4dGVuc2lvbikpIHtcbiAgICBpZiAoUGRmRWRpdG9yVmlldyA9PT0gbnVsbCkge1xuICAgICAgUGRmRWRpdG9yVmlldyA9IHJlcXVpcmUoJy4vcGRmLWVkaXRvci12aWV3Jyk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgUGRmRWRpdG9yVmlldyh1cmlUb09wZW4pO1xuICB9XG59XG5cbmZ1bmN0aW9uIHRvZ2dsZUJpbmFyeVZpZXcoKSB7XG4gIGlmKFBkZkVkaXRvclZpZXcgPT09IG51bGwpIHtcbiAgICBQZGZFZGl0b3JWaWV3ID0gcmVxdWlyZSgnLi9wZGYtZWRpdG9yLXZpZXcnKTtcbiAgfVxuICBjb25zdCBwYW5lSXRlbSA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVBhbmVJdGVtKCk7XG4gIGlmKCFwYW5lSXRlbSB8fCAhKHBhbmVJdGVtIGluc3RhbmNlb2YgUGRmRWRpdG9yVmlldykpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgcGFuZUl0ZW0uYmluYXJ5VmlldyA9ICFwYW5lSXRlbS5iaW5hcnlWaWV3O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVQZGZTdGF0dXNWaWV3KCkge1xuICBsZXQgUGRmU3RhdHVzQmFyVmlldyA9IHJlcXVpcmUoJy4vcGRmLXN0YXR1cy1iYXItdmlldycpO1xuICBuZXcgUGRmU3RhdHVzQmFyVmlldygpO1xuICBsZXQgUGRmR29Ub1BhZ2VWaWV3ID0gcmVxdWlyZSgnLi9wZGYtZ290by1wYWdlLXZpZXcnKTtcbiAgbmV3IFBkZkdvVG9QYWdlVmlldygpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVzZXJpYWxpemUoe2ZpbGVQYXRoLCBzY2FsZSwgc2Nyb2xsVG9wLCBzY3JvbGxMZWZ0fSkge1xuICBpZiAocmVxdWlyZSgnZnMtcGx1cycpLmlzRmlsZVN5bmMoZmlsZVBhdGgpKSB7XG4gICAgaWYgKFBkZkVkaXRvclZpZXcgPT09IG51bGwpIHtcbiAgICAgIFBkZkVkaXRvclZpZXcgPSByZXF1aXJlKCcuL3BkZi1lZGl0b3ItdmlldycpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFBkZkVkaXRvclZpZXcoZmlsZVBhdGgsIHNjYWxlLCBzY3JvbGxUb3AsIHNjcm9sbExlZnQpO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUud2FybihcIkNvdWxkIG5vdCBkZXNlcmlhbGl6ZSBQREYgZWRpdG9yIGZvciBwYXRoICcje2ZpbGVQYXRofScgYmVjYXVzZSB0aGF0IGZpbGUgbm8gbG9uZ2VyIGV4aXN0c1wiKTtcbiAgfVxufVxuXG5pZiAocGFyc2VGbG9hdChhdG9tLmdldFZlcnNpb24oKSkgPCAxLjcpIHtcbiAgYXRvbS5kZXNlcmlhbGl6ZXJzLmFkZCh7XG4gICAgXCJuYW1lXCI6IFwiUGRmRWRpdG9yRGVzZXJpYWxpemVyXCIsXG4gICAgXCJkZXNlcmlhbGl6ZVwiOiBkZXNlcmlhbGl6ZVxuICB9KTtcbn1cbiJdfQ==